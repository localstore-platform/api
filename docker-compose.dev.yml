version: '3.8'

services:
  postgres:
    ports:
      - '5432:5432'
    environment:
      POSTGRES_DB: localstore_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./docker/postgres/init-dev.sql:/docker-entrypoint-initdb.d/init-dev.sql

  redis:
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

  api:
    environment:
      - LOG_LEVEL=debug
      - ENABLE_GRAPHQL=true
      - ENABLE_WEBSOCKET=true
      - ENABLE_AI_FEATURES=true
    volumes:
      - .:/app
      - /app/node_modules
      - ./logs:/app/logs
    ports:
      - '3000:3000'
      - '9229:9229' # Node.js debugger
    command: npm run start:debug

  ai-service:
    environment:
      - LOG_LEVEL=debug
      - ENABLE_DEBUG=true
    volumes:
      - ./ai-service:/app
      - ./ai-service/models:/app/models
    ports:
      - '8000:8000'
      - '50051:50051'
      - '5678:5678' # Python debugger

  # Development tools
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: localstore-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@localstore.local
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - '5050:80'
    depends_on:
      - postgres
    networks:
      - localstore-network

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: localstore-redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - '8081:8081'
    depends_on:
      - redis
    networks:
      - localstore-network
